(function(){this.OrderBookUI=flight.component(function(){return this.attributes({bookLimit:30,askBookSel:"table.asks",bidBookSel:"table.bids",seperatorSelector:"table.seperator",fade_toggle_depth:"#fade_toggle_depth"}),this.update=function(event,data){return this.updateOrders(this.select("bidBookSel"),_.first(data.bids,this.attr.bookLimit),"bid"),this.updateOrders(this.select("askBookSel"),_.first(data.asks,this.attr.bookLimit),"ask")},this.appendRow=function(book,template,data){return data.classes="new",book.append(template(data))},this.insertRow=function(book,row,template,data){return data.classes="new",row.before(template(data))},this.updateRow=function(row,order,index,v1,v2){return row.data("order",index),v1.equals(v2)?void 0:(v2.greaterThan(v1)?row.addClass("text-up"):row.addClass("text-down"),row.data("volume",order[1]),row.find("td.volume").html(formatter.mask_fixed_volume(order[1])),row.find("td.amount").html(formatter.amount(order[1],order[0])))},this.mergeUpdate=function(bid_or_ask,book,orders,template){var $row,i,j,order,p1,p2,row,rows,v1,v2,_results;for(rows=book.find("tr"),i=j=0,_results=[];;)if(row=rows[i],order=orders[j],$row=$(row),row&&order)p1=new BigNumber($row.data("price")),v1=new BigNumber($row.data("volume")),p2=new BigNumber(order[0]),v2=new BigNumber(order[1]),"ask"===bid_or_ask&&p2.lessThan(p1)||"bid"===bid_or_ask&&p2.greaterThan(p1)?(this.insertRow(book,$row,template,{price:order[0],volume:order[1],index:j}),_results.push(j+=1)):p1.equals(p2)?(this.updateRow($row,order,j,v1,v2),i+=1,_results.push(j+=1)):($row.addClass("obsolete"),_results.push(i+=1));else if(row)$row.addClass("obsolete"),_results.push(i+=1);else{if(!order)break;this.appendRow(book,template,{price:order[0],volume:order[1],index:j}),_results.push(j+=1)}return _results},this.clearMarkers=function(book){var obsolete,obsolete_divs;return book.find("tr.new").removeClass("new"),book.find("tr.text-up").removeClass("text-up"),book.find("tr.text-down").removeClass("text-down"),obsolete=book.find("tr.obsolete"),obsolete_divs=book.find("tr.obsolete div"),obsolete_divs.slideUp("slow",function(){return obsolete.remove()})},this.updateOrders=function(table,orders,bid_or_ask){var book;return book=this.select(""+bid_or_ask+"BookSel"),this.mergeUpdate(bid_or_ask,book,orders,JST["templates/order_book_"+bid_or_ask]),book.find("tr.new div").slideDown("slow"),setTimeout(function(_this){return function(){return _this.clearMarkers(_this.select(""+bid_or_ask+"BookSel"))}}(this),900)},this.computeDeep=function(event,orders){var index,origVolume,price,volume,volume_fun;return index=Number($(event.currentTarget).data("order")),orders=_.take(orders,index+1),volume_fun=function(memo,num){return memo.plus(BigNumber(num[1]))},volume=_.reduce(orders,volume_fun,BigNumber(0)),price=BigNumber(_.last(orders)[0]),origVolume=_.last(orders)[1],{price:price,volume:volume,origVolume:origVolume}},this.placeOrder=function(target,data){return this.trigger(target,"place_order::input::price",data),this.trigger(target,"place_order::input::volume",data)},this.after("initialize",function(){return this.on(document,"market::order_book::update",this.update),this.on(this.select("fade_toggle_depth"),"click",function(_this){return function(){return _this.trigger("market::depth::fade_toggle")}}(this)),$(".asks").on("click","tr",function(_this){return function(e){var i;return i=$(e.target).closest("tr").data("order"),_this.placeOrder($("#bid_entry"),_.extend(_this.computeDeep(e,gon.asks),{type:"ask"})),_this.placeOrder($("#ask_entry"),{price:BigNumber(gon.asks[i][0]),volume:BigNumber(gon.asks[i][1])})}}(this)),$(".bids").on("click","tr",function(_this){return function(e){var i;return i=$(e.target).closest("tr").data("order"),_this.placeOrder($("#ask_entry"),_.extend(_this.computeDeep(e,gon.bids),{type:"bid"})),_this.placeOrder($("#bid_entry"),{price:BigNumber(gon.bids[i][0]),volume:BigNumber(gon.bids[i][1])})}}(this))})})}).call(this);