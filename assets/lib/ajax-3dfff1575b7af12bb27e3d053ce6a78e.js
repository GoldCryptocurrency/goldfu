(function(){var $,Ajax,Base,Collection,Extend,GenerateURL,Include,Model,PeatioModel,Queue,Singleton,__slice=[].slice,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};PeatioModel=this.PeatioModel||require("peatio_model"),$=PeatioModel.$,Model=PeatioModel.Model,Queue=$({}),Ajax={getURL:function(object){return null!=object.className?this.generateURL(object):this.generateURL(object,encodeURIComponent(object.id))},getCollectionURL:function(object){return this.generateURL(object)},getScope:function(object){return("function"==typeof object.scope?object.scope():void 0)||object.scope},getAfterScope:function(object){return("function"==typeof object.afterScope?object.afterScope():void 0)||object.afterScope},getCollection:function(object){return object.url!==object.generateURL?"function"==typeof object.url?object.url():object.url:null!=object.className?object.className.toLowerCase()+"s":void 0},generateURL:function(){var afterScope,args,collection,object,path,scope;return object=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[],collection=Ajax.getCollection(object)||Ajax.getCollection(object.constructor),scope=Ajax.getScope(object)||Ajax.getScope(object.constructor),afterScope=Ajax.getAfterScope(object)||Ajax.getAfterScope(object.constructor),args.unshift(collection),args.unshift(scope),args.push(afterScope),path=args.join("/"),path=path.replace(/(\/\/)/g,"/"),path=path.replace(/^\/|\/$/g,""),0!==path.indexOf("../")?Model.host+"/"+path:path},enabled:!0,disable:function(callback){var e;if(!this.enabled)return callback();this.enabled=!1;try{return callback()}catch(_error){throw e=_error}finally{this.enabled=!0}},queue:function(request){return request?Queue.queue(request):Queue.queue()},clearQueue:function(){return this.queue([])},config:{loadMethod:"GET",updateMethod:"PUT",createMethod:"POST",destroyMethod:"DELETE"}},Base=function(){function Base(){}return Base.prototype.defaults={dataType:"json",processData:!1,headers:{"X-Requested-With":"XMLHttpRequest"}},Base.prototype.queue=Ajax.queue,Base.prototype.ajax=function(params,defaults){return $.ajax(this.ajaxSettings(params,defaults))},Base.prototype.ajaxQueue=function(params,defaults,record){var deferred,jqXHR,parallel,promise,request,settings;return jqXHR=null,deferred=$.Deferred(),promise=deferred.promise(),Ajax.enabled?(settings=this.ajaxSettings(params,defaults),parallel=void 0!==settings.parallel?settings.parallel:"GET"===settings.type,request=function(next){var _ref;return null!=(null!=record?record.id:void 0)&&(null==settings.url&&(settings.url=Ajax.getURL(record)),null!=(_ref=settings.data)&&(_ref.id=record.id)),"string"!=typeof settings.data&&settings.processData!==!0&&(settings.data=JSON.stringify(settings.data)),jqXHR=$.ajax(settings).done(deferred.resolve).fail(deferred.reject).then(next,next),parallel?Queue.dequeue():void 0},promise.abort=function(statusText){var index;return jqXHR?jqXHR.abort(statusText):(index=$.inArray(request,this.queue()),index>-1&&this.queue().splice(index,1),deferred.rejectWith(settings.context||settings,[promise,statusText,""]),promise)},this.queue(request),promise):promise},Base.prototype.ajaxSettings=function(params,defaults){return $.extend({},this.defaults,defaults,params)},Base}(),Collection=function(_super){function Collection(model){this.model=model,this.failResponse=__bind(this.failResponse,this),this.recordsResponse=__bind(this.recordsResponse,this)}return __extends(Collection,_super),Collection.prototype.find=function(id,params,options){var record;return null==options&&(options={}),record=new this.model({id:id}),this.ajaxQueue(params,{type:options.method||Ajax.config.loadMethod,url:options.url||Ajax.getURL(record),parallel:options.parallel}).done(this.recordsResponse).fail(this.failResponse)},Collection.prototype.all=function(params,options){return null==options&&(options={}),this.ajaxQueue(params,{type:options.method||Ajax.config.loadMethod,url:options.url||Ajax.getURL(this.model),parallel:options.parallel}).done(this.recordsResponse).fail(this.failResponse)},Collection.prototype.fetch=function(params,options){var id;return null==params&&(params={}),null==options&&(options={}),(id=params.id)?(delete params.id,this.find(id,params,options).done(function(_this){return function(record){return _this.model.refresh(record,options)}}(this))):this.all(params,options).done(function(_this){return function(records){return _this.model.refresh(records,options)}}(this))},Collection.prototype.recordsResponse=function(data,status,xhr){return this.model.trigger("ajaxSuccess",null,status,xhr)},Collection.prototype.failResponse=function(xhr,statusText,error){return this.model.trigger("ajaxError",null,xhr,statusText,error)},Collection}(Base),Singleton=function(_super){function Singleton(record){this.record=record,this.failResponse=__bind(this.failResponse,this),this.recordResponse=__bind(this.recordResponse,this),this.model=this.record.constructor}return __extends(Singleton,_super),Singleton.prototype.reload=function(params,options){return null==options&&(options={}),this.ajaxQueue(params,{type:options.method||Ajax.config.loadMethod,url:options.url,parallel:options.parallel},this.record).done(this.recordResponse(options)).fail(this.failResponse(options))},Singleton.prototype.create=function(params,options){return null==options&&(options={}),this.ajaxQueue(params,{type:options.method||Ajax.config.createMethod,contentType:"application/json",data:this.record.toJSON(),url:options.url||Ajax.getCollectionURL(this.record),parallel:options.parallel}).done(this.recordResponse(options)).fail(this.failResponse(options))},Singleton.prototype.update=function(params,options){return null==options&&(options={}),this.ajaxQueue(params,{type:options.method||Ajax.config.updateMethod,contentType:"application/json",data:this.record.toJSON(),url:options.url,parallel:options.parallel},this.record).done(this.recordResponse(options)).fail(this.failResponse(options))},Singleton.prototype.destroy=function(params,options){return null==options&&(options={}),this.ajaxQueue(params,{type:options.method||Ajax.config.destroyMethod,url:options.url,parallel:options.parallel},this.record).done(this.recordResponse(options)).fail(this.failResponse(options))},Singleton.prototype.recordResponse=function(options){return null==options&&(options={}),function(_this){return function(data,status,xhr){var _ref;return Ajax.disable(function(){return PeatioModel.isBlank(data)||_this.record.destroyed?void 0:(data.id&&_this.record.id!==data.id&&_this.record.changeID(data.id),_this.record.refresh(data))}),_this.record.trigger("ajaxSuccess",data,status,xhr),null!=(_ref=options.done)?_ref.apply(_this.record):void 0}}(this)},Singleton.prototype.failResponse=function(options){return null==options&&(options={}),function(_this){return function(xhr,statusText,error){var _ref;return _this.record.trigger("ajaxError",xhr,statusText,error),null!=(_ref=options.fail)?_ref.apply(_this.record):void 0}}(this)},Singleton}(Base),Model.host="",GenerateURL={include:function(){var args;return args=1<=arguments.length?__slice.call(arguments,0):[],args.unshift(encodeURIComponent(this.id)),Ajax.generateURL.apply(Ajax,[this].concat(__slice.call(args)))},extend:function(){var args;return args=1<=arguments.length?__slice.call(arguments,0):[],Ajax.generateURL.apply(Ajax,[this].concat(__slice.call(args)))}},Include={ajax:function(){return new Singleton(this)},generateURL:GenerateURL.include,url:GenerateURL.include},Extend={ajax:function(){return new Collection(this)},generateURL:GenerateURL.extend,url:GenerateURL.extend},Model.Ajax={extended:function(){return this.fetch(this.ajaxFetch),this.change(this.ajaxChange),this.extend(Extend),this.include(Include)},ajaxFetch:function(){var _ref;return(_ref=this.ajax()).fetch.apply(_ref,arguments)},ajaxChange:function(record,type,options){return null==options&&(options={}),options.ajax!==!1?record.ajax()[type](options.ajax,options):void 0}},Model.Ajax.Methods={extended:function(){return this.extend(Extend),this.include(Include)}},Ajax.defaults=Base.prototype.defaults,Ajax.Base=Base,Ajax.Singleton=Singleton,Ajax.Collection=Collection,PeatioModel.Ajax=Ajax,"undefined"!=typeof module&&null!==module&&(module.exports=Ajax)}).call(this);